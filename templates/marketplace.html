{% extends "base.html" %}

{% block title %}Simulacrum - Маркетплейс займов{% endblock %}

{% block extra_head %}
<style>
    .loan-card {
        transition: transform 0.2s;
    }
    .loan-card:hover {
        transform: translateY(-5px);
    }
    .ltv-indicator {
        width: 100%;
        height: 5px;
        border-radius: 3px;
        margin-top: 5px;
    }
    .ltv-safe {
        background-color: #28a745;
    }
    .ltv-warning {
        background-color: #ffc107;
    }
    .ltv-danger {
        background-color: #dc3545;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="fw-bold">Маркетплейс займов</h1>
                <p class="lead">Выберите заявку для финансирования и начните зарабатывать</p>
            </div>
        </div>

        <div class="filter-section">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Поиск по описанию...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select">
                        <option selected>Сортировать по...</option>
                        <option value="newest">Сначала новые</option>
                        <option value="rate">Выгодная ставка</option>
                        <option value="amount">Сумма займа</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3">
                    <label class="form-label">Сумма займа</label>
                    <select class="form-select">
                        <option selected>Любая</option>
                        <option value="small">До 1,000 USDC</option>
                        <option value="medium">1,000-5,000 USDC</option>
                        <option value="large">Более 5,000 USDC</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Срок</label>
                    <select class="form-select">
                        <option selected>Любой</option>
                        <option value="short">До 30 дней</option>
                        <option value="medium">30-90 дней</option>
                        <option value="long">Более 90 дней</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ставка</label>
                    <select class="form-select">
                        <option selected>Любая</option>
                        <option value="low">До 10%</option>
                        <option value="medium">10-20%</option>
                        <option value="high">Более 20%</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">LTV</label>
                    <select class="form-select">
                        <option selected>Любой</option>
                        <option value="safe">До 50% (безопасно)</option>
                        <option value="medium">50-70% (умеренно)</option>
                        <option value="high">Более 70% (рискованно)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            {% for loan in loans %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card loan-card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-primary">#{{ loan.id }}</span>
                            <span class="badge {% if loan.status == LoanStatus::InProgress %}bg-warning{% else %}bg-success{% endif %}">
                                {{ loan.status }}
                            </span>
                        </div>
                        
                        <h3 class="h5">Заем: {{ loan.amount }}</h3>
                        <p class="text-muted mb-2">Ставка: <strong>{{ loan.rate }}</strong> годовых</p>
                        <p class="text-muted mb-2">Срок: <strong>{{ loan.term.num_days() }} дней</strong></p>
                        <p class="text-muted mb-2">Залог: <strong>{{ loan.collateral }}</strong></p>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <span>LTV: <strong>{{ loan.ltv }}</strong></span>
                                <span>
                                    {% if loan.ltv <= Percent(50.0) %}
                                        <i class="bi bi-check-circle-fill text-success"></i> Безопасно
                                    {% elif loan.ltv <= Percent(70.0) %}
                                        <i class="bi bi-exclamation-triangle-fill text-warning"></i> Умеренно
                                    {% else %}
                                        <i class="bi bi-exclamation-triangle-fill text-danger"></i> Рискованно
                                    {% endif %}
                                </span>
                            </div>
                            <div class="ltv-indicator {% if loan.ltv <= Percent(50.0) %}ltv-safe{% elif loan.ltv <= Percent(70.0) %}ltv-warning{% else %}ltv-danger{% endif %}"></div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">Создано: {{ loan.created_at }}</small>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-0">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#fundModal{{ loan.id }}">
                            <i class="bi bi-cash-coin me-2"></i>Финансировать
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="fundModal{{ loan.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Финансирование займа #{{ loan.id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Вы собираетесь профинансировать займ на сумму <strong>{{ loan.amount }}</strong> под <strong>{{ loan.rate }}</strong> годовых.</p>
                            <p>Залог заемщика: <strong>{{ loan.collateral }}</strong> (LTV: {{ loan.ltv }}).</p>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle me-2"></i>Средства будут заблокированы в смарт-контракте до погашения займа.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-primary">Подтвердить финансирование</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="row mt-4">
            <div class="col-12 text-center">
                <button class="btn btn-outline-primary">Показать еще</button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Marketplace page loaded');
    });
</script>
{% endblock %}
